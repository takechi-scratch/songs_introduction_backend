# 「MIMIさん全曲紹介」YouTube API 実装ドキュメント

## クライアントの概要

「MIMIさん全曲紹介」は、アーティスト [MIMI](https://www.youtube.com/@MIMI...official) さんの広報活動を目的として、個人が趣味で運営しているWebアプリです。
アプリでは、MIMIさんが作曲した楽曲を記録し、一覧表示する機能を提供しています。また、このアプリでは、製作者が手作業で作成した楽曲の分析データを使用し、おすすめの曲の提案もしています。

## クライアントがYouTube APIを使用する目的

YouTube APIを活用して、以下の機能を提供しています。

1. **動画メタデータ取得**: タイトル、説明、再生時間、サムネイルを取得し、曲の一覧表示や詳細情報ページの中で使用しています。
2. **動画の埋め込み**: 動画の詳細ページでは、埋め込みを使用して気になった曲をすぐに再生することができます。
3. **再生リストの自動生成**: ユーザーの好みに応じて、YouTubeで再生リストを自動で作成できます。

実際の使用シーンについては、 [こちらの動画](https://www.youtube.com/watch?v=81pjSTETDxQ) で詳しく説明しています。

## コードの詳細

クライアントのソースコードは、GitHubで公開しています。

- フロントエンド: https://github.com/takechi-scratch/songs_introduction_www
- バックエンド: https://github.com/takechi-scratch/songs_introduction_backend

ここでは、バックエンドにおいてYouTube Data APIを使用しているコードを紹介します。


### 1. `api.py` - コア API クライアント

**ソースコード**: https://github.com/takechi-scratch/songs_introduction_backend/blob/main/utils/youtube/api.py

**目的**: YouTube Data API v3 とのすべての直接的なインタラクションを管理

**主要なクラスと関数**:

- **`OAuthClient`**: OAuth 2.0 認証、トークンライフサイクルの管理
  - リフレッシュトークンを使用したアクセストークンの更新管理
  - APScheduler を使用した自動トークン更新の実装
  - 再生リスト作成と動画挿入のメソッドを提供

- **`list_videos(video_ids: list[str])`**: バッチで動画メタデータを取得
  - API キーを用いた動画情報の取得
  - API へのリクエストを動画 50 本ずつに分割し、クォータ消費を最小化

**OAuth 2.0 フローの実装**:
```
1. 初期セットアップ: 環境変数に refresh_token を保存
2. トークン更新: refresh_token を利用して access_token を取得し保管
3. スケジューリング: 有効期限の 60 秒前に次回更新をスケジュール
4. API 呼び出し: すべての認証済みリクエストに有効な access_token を使用
```

### 2. `playlists.py` - 再生リスト管理レイヤー

**ソースコード**: https://github.com/takechi-scratch/songs_introduction_backend/blob/main/utils/youtube/playlists.py

**主要なクラス**:

- **`PlaylistManager`**: キャッシュを含めた、効率的な再生リストの作成・管理
  - 同一の動画セットに対して 3 日間のキャッシュを実装、API 呼び出しの削減
  - HTTP エラーハンドリングの実装

**キャッシュ戦略**:
- キー: 動画 ID のセット
- 値: メタデータと作成時刻を持つ `YoutubePlaylist` オブジェクト
- TTL: 3 日間

## 使用する YouTube Data API の詳細

### 1. 動画メタデータ取得

**ユースケース**: 楽曲一覧を作成するために動画情報を取得

**API エンドポイント**: `GET /youtube/v3/videos`

**クォータコスト**: リクエストあたり 1 ユニット

**頻度**:
キャッシュの定期更新: 1日1回、最大10リクエスト程度

### 2. 再生リスト作成

**ユースケース**: ユーザーのリクエストに応じて、公開再生リストを生成

**API エンドポイント**: `POST /youtube/v3/playlists`

**クォータコスト**: リクエストあたり 50 ユニット

**頻度**:
- 現在: 1 日あたり 5 リクエスト程度（製作者のテストに限定しています）
- 今後: 1 日あたり 50 人のアクセス・ユーザーあたり 1 リクエスト・合計 50 リクエストを目標

### 3. 再生リストアイテム挿入

**ユースケース**: 作成した再生リストに動画を追加

**API エンドポイント**: `POST /youtube/v3/playlistItems`

**クォータコスト**: 動画あたり 50 ユニット

**頻度**:
現在は製作者のみ利用可能なため、クォータコストを超過しないよう、
10000 / 50 = 200 リクエストまでの範囲内で実験しています。

今後は、

- 再生リスト作成あたり、最大 50 本の動画
- 1 日の合計: 50(ユーザー/日) * 50(本/ユーザー) = 2500(本) の動画挿入

を目標としています。


### フロントエンドとの統合（バックエンドAPIの詳細）

バックエンドAPI: https://mimi-api.takechi.f5.si/docs/

1. **POST `/playlists/create`**:
   - ユーザーのリクエストから再生リストを作成
   - 再生リストの URL を返す
   - API 呼び出しを削減するためにキャッシュ機能を実装

2. **GET `/songs/{song_id}`**:
   - キャッシュされた YouTube 動画のデータを返す
   - 曲の詳細情報表示に使用

3. **バックグラウンドジョブ**:
   - 動画データの更新（毎日）
   - クォータ使用量の監視と通知（実装予定）
